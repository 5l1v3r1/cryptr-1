<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="login-form">
	<template>
		<style>
			#errortoast {
				background-color: #EF5350;
			}
			#userfield, #passfield, #initfield {
				margin: 0;
			}
			paper-dialog > *:last-child {
				margin: 0;
				padding: 0px;
			}
			paper-progress {
				width: auto;
			}
			paper-progress.blue {
				--paper-progress-active-color: #03A9F4;
			}
		</style>

		<iron-ajax id="authenticateReq"
			url="{{authURL}}"
			handle-as="json"
			method="POST"
			body="{{body}}"
			content-type="application/json"
			last-response="{{loginResponse}}"
			last-error={{loginError}}
			on-response="_success"
			on-error="_error"
			timeout="5000">
		</iron-ajax>

		<!-- Todo: First talk to v1/sys/init to verify the URL as a Vault instance -->
		<!-- Todo: When implementing token auth, set username as "TOKEN" -->

		<paper-dialog id="modal" class="white noselect" modal no-cancel-on-esc-key no-cancel-on-outside-click>
			<h1>Login</h1>
			<div id="initfield">
				<paper-input value="{{url}}" label="Server URL (HTTPS)"></paper-input>
			</div>
			<paper-input id="userfield" value="{{username}}" label="LDAP Username"></paper-input>
			<paper-input id="passfield" value="{{password}}" label="Password" type="password"></paper-input>
			<div class="buttons">
				<iron-a11y-keys target="[[targetuser]]" keys="enter" on-keys-pressed="_login"></iron-a11y-keys>
				<iron-a11y-keys target="[[targetpass]]" keys="enter" on-keys-pressed="_login"></iron-a11y-keys>
				<paper-button on-tap="_login" autofocus disabled="{{disabled}}">Login</paper-button>
			</div>
			<paper-progress class="blue" indeterminate disabled="{{!disabled}}"></paper-progress>
		</paper-dialog>

		<paper-toast id="errortoast" class="fit-bottom" duration="5000" text""></paper-toast>
	</template>

	<script>
		(function() {
			'use strict';
			Polymer({
				is: 'login-form',
				properties: {
					status: {
						type: String,
						value: '',
						notify: true,
						observer: '_watchStatus'
					},
					body: {
						computed: '_computeBody(password)'
					},
					targetuser: {
						type: Object,
						value: function() {
							return this.$.userfield;
						}
					},
					targetpass: {
						type: Object,
						value: function() {
							return this.$.passfield;
						}
					},
					username: {
						type: String,
						value: '',
						notify: true,
						observer: '_persistData'
					},
					password: {
						type: String,
						value: ''
					},
					disabled: {
						type: Boolean,
						value: false
					},
					url: {
						type: String,
						notify: true,
						observer: '_persistData'
					},
					authURL: {
						computed: '_computeURL(url, username)'
					},
					header: {
						type: String,
						notify: true,
						value: ''
					}
				},
				attached: function() {
					this.status = 'none';
				},
				_computeBody: function(p) {
					return {"password": p };
				},
				_computeURL: function(url, u) {
					return this.url + 'v1/auth/ldap/login/' + u
				},
				_login: function() {
					this.url = this.url.trim();
					if (this.url.toLowerCase().startsWith('https')) {
						if (!(this.url.endsWith('/'))) this.url += '/';
						this.disabled = true;
						this.$.authenticateReq.generateRequest();
					} else {
						this.$.errortoast.text = 'An HTTPS based URL is required.';
						this.$.errortoast.show();
					}
				},
				_success: function() {
					if (this.loginResponse.auth.client_token) {
						this.header = {"X-Vault-Token": this.loginResponse.auth.client_token };
						this.status = 'watch';
						this.password = '';
						this.disabled = false;
						this.$.modal.close();
					}
				},
				_error: function(e) {
					this.disabled = false;
					if (this.loginError.response.errors[0].includes('Invalid Credentials')) this.$.errortoast.text = 'Invalid Credentials.';
					if (this.loginError.response.errors[0] == 'missing client token') this.$.errortoast.text = 'Auth Backend not supported!';
					// else if (e.detail.error.message.includes('503')) this.$.errortoast.text = 'Cannot contact server. Please try again later.';
					// else if (e.detail.error.message.includes('401')) this.$.errortoast.text = 'Unauthorized Request.';
					else this.$.errortoast.text = 'Unkown Error: Please try again later.';
					this.$.errortoast.show();
				},
				_watchStatus: function() {
					if (this.status == 'none') this.$.modal.open();
				},
				_persistData: function() {
					ipcRenderer.send('update-url', this.url);
					ipcRenderer.send('update-user', this.username);
				}
			});
		})();
	</script>
</dom-module>
