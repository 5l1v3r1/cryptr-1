<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="login-form">
	<template>
		<style>
			:host {
				--paper-tabs-selection-bar-color: blue;
				--paper-tabs-selection-bar: {
					color: white;
				};
				/*--paper-tabs: {
					background-color: blue;
				}*/
			}
			#errortoast {
				background-color: #EF5350;
			}
			#userfield, #passfield, #initfield {
				margin: 0;
			}
			paper-dialog > iron-pages {
				margin: 0;
			}
			paper-dialog > *:last-child {
				margin: 0;
				padding: 0px;
			}
			paper-progress {
				width: auto;
			}
			paper-progress.blue {
				--paper-progress-active-color: #03A9F4;
			}
		</style>

		<iron-ajax id="authenticateReq"
			url="{{authURL}}"
			handle-as="json"
			method="{{authMethod}}"
			body="{{body}}"
			headers="{{header}}"
			content-type="application/json"
			last-response="{{loginResponse}}"
			last-error={{loginError}}
			on-response="_success"
			on-error="_error"
			timeout="5000">
		</iron-ajax>

		<!-- Todo: First talk to v1/sys/init to verify the URL as a Vault instance -->

		<paper-dialog id="modal"class="noselect" modal no-cancel-on-esc-key no-cancel-on-outside-click auto-fit-on-attach>
			<h1>Login</h1>
			<paper-tabs selected="{{selected}}">
				<paper-tab>LDAP</paper-tab>
				<paper-tab>Token</paper-tab>
				<paper-tab>User/Pass</paper-tab>
			</paper-tabs>
			<div id="initfield">
				<paper-input value="{{url}}" label="Server URL (HTTPS)"></paper-input>
			</div>
			<iron-pages selected="{{selected}}">
				<div>
					<paper-input id="userfield" value="{{username}}" label="LDAP Username"></paper-input>
					<paper-input id="passfield" value="{{password}}" label="LDAP Password" type="password"></paper-input>
				</div>
				<div>
					<paper-input id="userfield" value="{{token}}" label="Token"></paper-input>
				</div>
				<div>
					<paper-input id="userfield" value="{{username}}" label="Username"></paper-input>
					<paper-input id="passfield" value="{{password}}" label="Password" type="password"></paper-input>
				</div>
			</iron-pages>
			<div class="buttons">
				<iron-a11y-keys target="[[targetuser]]" keys="enter" on-keys-pressed="_login"></iron-a11y-keys>
				<iron-a11y-keys target="[[targetpass]]" keys="enter" on-keys-pressed="_login"></iron-a11y-keys>
				<paper-button on-tap="_login" autofocus disabled="{{disabled}}">Login</paper-button>
			</div>
			<paper-progress class="blue" indeterminate disabled="{{!disabled}}"></paper-progress>
		</paper-dialog>

		<paper-toast id="errortoast" class="fit-bottom" duration="5000" text""></paper-toast>
	</template>

	<script>
		(function() {
			'use strict';
			Polymer({
				is: 'login-form',
				properties: {
					status: {
						type: String,
						value: '',
						notify: true,
						observer: '_watchStatus'
					},
					targetuser: {
						type: Object,
						value: function() {
							return this.$.userfield;
						}
					},
					targetpass: {
						type: Object,
						value: function() {
							return this.$.passfield;
						}
					},
					username: {
						type: String,
						value: '',
						notify: true,
						observer: '_persistData'
					},
					body: Object,
					password: String,
					authURL: String,
					disabled: {
						type: Boolean,
						value: false
					},
					url: {
						type: String,
						notify: true,
						observer: '_persistData'
					},
					header: {
						type: Object,
						notify: true
					},
					initialResponse: {
						type: Array,
						notify: true
					},
					selected: {
						type: Number,
						value: 0,
						notify: true,
						observer: '_watchSelected'
					},
					authMethod: {
						type: String,
						value: 'POST'
					}
				},
				attached: function() {
					this.status = 'none';
				},
				_computeBody: function(p) {
					return {"password": p };
				},
				_computeURL: function(url, u) {
					return this.url + 'v1/auth/ldap/login/' + u
				},
				_login: function() {
					this.url = this.url.trim();
					if (this.url.toLowerCase().startsWith('https')) {
						if (!(this.url.endsWith('/'))) this.url += '/';
						this.disabled = true;
						// Switch for LDAP, Token, and UserPass auth backends
						if (this.selected == 0) {
							this.authMethod = 'POST';
							this.authURL = this.url + 'v1/auth/ldap/login/' + this.username;
							this.body = {"password": this.password };
						} else if (this.selected == 1) {
							this.authMethod = 'GET';
							this.authURL = this.url + 'v1/auth/token/lookup-self';
							this.header = {"X-Vault-Token": this.token };
							this.body = '';
						} else if (this.selected == 2) {
							this.authMethod = 'POST';
							this.authURL = this.url + 'v1/auth/userpass/login/' + this.username;
							this.body = {"password": this.password };
						}
						this.$.authenticateReq.generateRequest();
					} else {
						this.$.errortoast.text = 'An HTTPS based URL is required.';
						this.$.errortoast.show();
					}
				},
				_success: function() {
					// UserPass / LDAP
					if (this.loginResponse.auth && this.loginResponse.auth.client_token) {
						this.header = {"X-Vault-Token": this.loginResponse.auth.client_token };
						this.initialResponse = this.loginResponse.auth;
						this.status = 'watch';
						this.password = '';
						this.disabled = false;
						this.$.modal.close();
					// Token Auth
					} else if (this.loginResponse.data) {
						this.initialResponse = this.loginResponse.data;
						this.username = 'TOKEN';
						this.status = 'watch';
						this.password = '';
						this.disabled = false;
						this.$.modal.close();
					}
				},
				_error: function(e) {
					this.disabled = false;
					if (this.loginError.response.errors[0].includes('Invalid Credentials')) this.$.errortoast.text = 'Invalid Credentials.';
					else if (this.loginError.response.errors[0] == 'invalid username or password') this.$.errortoast.text = 'Invalid Username or Password';
					else if (this.loginError.response.errors[0] == 'missing client token') this.$.errortoast.text = 'Permission Denied';
					else if (this.loginError.response.errors[0] == 'Vault is sealed') this.$.errortoast.text = 'Vault is still sealed!';
					else if (this.loginError.response.errors[0] == 'permission denied') this.$.errortoast.text = 'Permission Denied';
					else this.$.errortoast.text = 'Unkown Error: Please try again later.';
					this.$.errortoast.show();
				},
				_watchStatus: function() {
					if (this.status == 'none') this.$.modal.open();
				},
				_watchSelected: function() {
					this.username = '';
					this.password = '';
					this.token = '';
					this._persistData();
				},
				_persistData: function() {
					ipcRenderer.send('update-url', this.url);
					ipcRenderer.send('update-user', this.username);
					ipcRenderer.send('update-loginpage', this.selected);
				}
			});
		})();
	</script>
</dom-module>
