<!--
Copyright 2017 Adobe. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<dom-module id="secret-item">
	<style>
		:host {
		}
		.flex {
			@apply(--layout-flex);
		}
		.center {
			height: calc(100vh - 64px);
			@apply(--layout-horizontal);
			@apply(--layout-center-center);
		}
		.items {
			@apply(--layout-vertical);
		}
		.horizontal {
			@apply(--layout-horizontal);
		}
		paper-toast {
			right: 10px;
			left: auto !important;
			background-color: var(--accent-color);
			min-width: 95px;
		}
		paper-toast.err {
			background-color: red;
		}
		a {
			color: black;
			text-decoration: none;
		}

	</style>
	<template>
		<iron-ajax id="getSecret"
			url="{{secretURL}}"
			handle-as="json"
			headers="{{header}}"
			on-error="_getError"
			on-response="_getSuccess"
			last-response="{{response}}">
		</iron-ajax>

		<iron-ajax id="deleteSecret"
			url="{{secretURL}}"
			handle-as="json"
			method="delete"
			headers="{{header}}"
			on-error="_deleteError"
			on-response="_deleteSuccess"
			last-response="{{response}}">
		</iron-ajax>

		<iron-ajax id="updateSecret"
			url="{{secretURL}}"
			method="post"
			body="{{body}}"
			handle-as="json"
			content-type="application/json"
			headers="{{header}}"
			on-error="_updateError"
			on-response="_updateSuccess"
			last-response="{{response}}">
		</iron-ajax>

		<iron-ajax id="capabilities"
			url="{{capabilitiesURL}}"
			method="post"
			body="{{body}}"
			handle-as="json"
			on-error="_watchCapabilitiesRequests"
			on-response="_watchCapabilitiesRequests"
			content-type="application/json"
			headers="{{header}}">
		</iron-ajax>

		<paper-toast id="copied" duration="1500" text="Copied"></paper-toast>
		<paper-toast id="updated" duration="1500" text="Updated"></paper-toast>
		<paper-toast id="error" class="err" duration="5000" text="An unknown error occurred"></paper-toast>

		<paper-dialog id="deleteModal" no-cancel-on-outside-click no-cancel-on-esc-key>
			<h2>Delete?</h2>
			<p>Are you sure you want to delete this item?</p>
			<div class="buttons">
				<paper-button dialog-dismiss on-tap="_cancelDelete">Cancel</paper-button>
				<paper-button dialog-confirm autofocus on-tap="_deleteKey">Delete</paper-button>
			</div>
		</paper-dialog>

		<div class="flex">
			<div class="center">
				<div>
					<paper-button on-tap="_confirmDelete" raised>Delete</paper-button>
					<paper-button on-tap="_updateKey" raised>Update</paper-button>
					<div class="horizontal">
						<paper-item style="width: 200px; text-align: right;">Location:</paper-item>
						<paper-item>
							<paper-input value="{{newLocation}}" label="Location" no-label-float style="width: 200px"></paper-input>
							<paper-button on-tap="_moveKey" raised>Move</paper-button>
						</paper-item>
					</div>
					<iron-pages selected="{{selected}}">
					  <section>
						  <template is="dom-repeat" items="{{data}}">
							  <div class="horizontal">
								  <paper-item>
									  <paper-input value="{{item.key}}" label="Name" no-label-float style="width: 200px; text-align: right;"></paper-input>
								  </paper-item>
								  <paper-item>
									  <paper-input value="{{item.value}}" label="Value" no-label-float style="width: 200px"></paper-input>
								  </paper-item>
								  <paper-item>
									  <paper-button style="color: #999; font-size: small;" on-tap="_copy">Copy</paper-button>
								  </paper-item>
							  </div>
						  </template>
					  </section>
					  <section>
						  {{response.data.filename}}
						  <a download$="{{response.data.filename}}" href$="{{response.data.data}}">
							  <paper-button raised>
								  Download
							  </paper-button>
						  </a>
						  <!-- <granite-file-reader read-as="dataURL" on-file-read="_fileUpload">
							  <paper-button raised>
								  Upload File
							  </paper-button>
						  </granite-file-reader> -->
					  </section>
					  <section></section>
					</iron-pages>
				</div>
			</div>
		</div>
	</template>

	<script>
	Polymer({
		is: "secret-item",
		properties: {
			secrets: {
				type: Array,
				notify: true
			},
			header: Object,
			url: String,
			newLocation: String,
			location: {
				type: String,
				observer: '_watchLocation'
			},
			route: {
				type: String,
				observer: '_watchRoute'
			},
			data: {
				type: Array,
				value: []
			},
			selected: {
				type: Number,
				value: 0
			},
			body: Object,
			loading: {
				notify: true
			},
			capabilitiesRequests: {
				type: Array,
				value: []
			},
			moveRequest: {
				type: Object,
				value: {}
			}
		},
		// ---------- Other ----------
		_fileUpload: function(e, file){
			console.log('FILE: ', file);
		},
		_copy: function(e) {
			clipboard.writeText(e.model.item.value);
			this.$.copied.show();
		},
		_reAddSecret: function() {
			var parts = this.moveRequest.newLocation.split('/');
			var name = parts.pop();
			this.push('secrets', {location: this.moveRequest.newLocation, value: {}, type: "secret", parent: parts.join('/'), name: name, parsedname: name.replace(/_/g, ' ')});
			// Add containing folder
			var found = false;
			for (var i = parts.length - 1; i > 0; i--) {
				for (var i = 0; i < this.secrets.length; i++) {
					if (this.secrets[i].location == parts.join('/')) {
						found = true;
						break;
					}
				}
				if (!found) {
					var loc = parts.join('/');
					var foldername = parts.pop();
					this.push('secrets', {location: loc, value: {}, type: "folder", parent: parts.join('/'), name: foldername, parsedname: foldername.replace(/_/g, ' ')});
				} else break;
			}
		},
		_deleteContainingFolder: function(location) {
			var found = false;
			var index = -1;
			for (var i = 0; i < this.secrets.length; i++) {
				if (this.secrets[i].parent == location) found = true;
				if (this.secrets[i].location == location && this.secrets[i].type == 'folder') index = i;
			}
			if (!found) {
				this.splice('secrets', index, 1);
				var parts = location.split('/');
				parts.pop();
				this._deleteContainingFolder(parts.join('/'));
			}
		},
		// ---------- Watch ----------
		_watchCapabilitiesRequests: function() {
			// Wait for all capabilities requests to return.
			var complete = true;
			for (var i = 0; i < this.capabilitiesRequests.length; i++)
				if (this.capabilitiesRequests[i].status == 0) complete = false;
			if (complete) {
				if (this.capabilitiesRequests[0].response.data.capabilities.includes('delete')) {
					if (this.capabilitiesRequests[1].response.data.capabilities.includes('create')) {
						// Execute Move step #2 on new location.
						this.secretURL = app.url + 'v1/' + this.newLocation;
						this.moveRequest = {
							oldLocation: this.location,
							newLocation: this.newLocation,
							update: this._updateKey(),
							delete: {}
						};
					}
				} else {
					this.$.error.text = "You don't have the rights to move this secret. Check for 'Delete' and 'Create' capabilities failed.";
					this.$.error.show();
					this.loading = false;
				}
			}
		},
		_watchLocation: function() {
			this.secretURL = app.url + 'v1/' + this.location;
			this.capabilitiesURL = app.url + 'v1/sys/capabilities-self';
			this.url = app.url + 'v1';
			this.newLocation = this.location;
		},
		_watchRoute: function() {
			if (this.route == 'secret/' + this.location) {
				this.$.getSecret.generateRequest();
				this.loading = true;
			}
		},
		_watchMoveRequest: function(request) {
			if (Object.keys(this.moveRequest).length) {
				if (Object.keys(this.moveRequest.delete).length && this.moveRequest.delete.status == 204) { // Move process complete
					this.moveRequest = {};
					this.loading = false;
					document.getElementById('move').show();
				} else if (Object.keys(this.moveRequest.delete).length && this.moveRequest.delete.status != 204) { // Delete failed
					this.moveRequest = {}
					this.loading = false;
					this.$.error.text = "Move failed. You may want to check both old and new locations for duplicates";
					this.$.error.show();
				} else if (Object.keys(this.moveRequest.update).length && this.moveRequest.update.status == 204) { // Update complete, now delete
					this._deleteKey();
				} else if (Object.keys(this.moveRequest.update).length && this.moveRequest.update.status != 204) { // Update failed
					this.moveRequest = {};
					this.loading = false;
				} else { // Catch all error
					this.moveRequest = {};
					this.loading = false;
					this.$.error.text = "Move: An unknown error occurred";
					this.$.error.show();
				}
				return true;
			} else return false;
		},
		// ---------- Confirm ----------
		_confirmDelete: function() {
			this.$.deleteModal.open();
		},
		_cancelDelete: function() {
			this.$.deleteModal.close();
		},
		// ---------- Execute ----------
		_deleteKey: function() {
			if (this.moveRequest && this.moveRequest.oldLocation) {
				this.secretURL = app.url + 'v1/' + this.moveRequest.oldLocation;
				this.moveRequest.delete = this.$.deleteSecret.generateRequest();
			} else this.$.deleteSecret.generateRequest();
			this.loading = true;
		},
		_updateKey: function() {
			var temp = {};
			for (var i = 0; i < this.data.length; i++) {
				temp[this.data[i].key] = this.data[i].value;
			}
			this.body = temp;
			this.loading = true;
			return this.$.updateSecret.generateRequest();
		},
		_moveKey: function() {
			// Move: 1. Check for Delete and Create capabilities on respective locations. 2. Create new secret, wait for success. 3. Delete old secret
			if (this.location == this.newLocation) {
				this.$.error.text = "You must specify a new location for this secret!";
				this.$.error.show();
			} else {
				this.body = {path: this.location};
				this.push('capabilitiesRequests', this.$.capabilities.generateRequest());
				this.body = {path: this.newLocation};
				this.push('capabilitiesRequests', this.$.capabilities.generateRequest());
				this.loading = true;
			}
		},
		// ---------- Success ----------
		_getSuccess: function(e) {
			this.loading = false;
			this.data = [];
			if ( this.response.data.filename &&
				this.response.data.type &&
				this.response.data.type == 'file' )
				this.selected = 1;
			for (var key in this.response.data) {
				this.push('data', {key: key, value: this.response.data[key]});
			}
		},
		_deleteSuccess: function(e) {
			this.loading = false;
			this.secretURL = app.url + 'v1/' + this.location;
			for (var i = 0; i < this.secrets.length; i++) {
				if (this.secrets[i].location == this.location && this.secrets[i].type == 'secret') {
					var secret = this.splice('secrets', i, 1);
					if (Object.keys(this.moveRequest).length) this._reAddSecret(this.moveRequest); // Check if secret is moved
					this._deleteContainingFolder(secret[0].parent);
					break;
				}
			}
			if (!this._watchMoveRequest()) document.getElementById('deleted').show();
			page('#!/');
		},
		_updateSuccess: function() {
			this.loading = false;
			if (!this._watchMoveRequest()) this.$.updated.show();
		},
		// ---------- Error ----------
		_getError: function(e) {
			this.loading = false;
			this.$.error.text = "An error occurred while retrieving this secret. Check permissions?";
			this.$.error.show();
		},
		_deleteError: function(e) {
			this.loading = false;
			this.$.error.text = "An error occurred while deleting this secret. Check permissions?";
			this.$.error.show();
		},
		_updateError: function(e) {
			this.loading = false;
			this.$.error.text = "An error occurred while updating this secret. Check permissions?";
			this.$.error.show();
		}
	});
	</script>
</dom-module>
