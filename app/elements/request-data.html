<dom-module id="request-data">
	<template>

		<iron-ajax id="getPolicy"
			url="{{getPoliciesURL}}"
			handle-as="json"
			headers="{{header}}"
			on-error="_policyFailure"
			on-response="_policySuccess">
		</iron-ajax>

	</template>
	<script>
		(function() {
			'use strict';
			Polymer({
				is: 'request-data',
                properties: {
                    status: {
    					notify: true,
    					observer: '_watchStatus'
    				},
    				data: {
    					notify: true
    				},
					access: {
						type: Object,
						value: {}
					},
					policyRequests: {
						type: Array,
						value: []
					},
					header: Object,
					initialResponse: {
						type: Array,
						value: []
					}
				},
				_parseAccess: function() {

				},
				_policySuccess: function(e) {
					var rules = hcltojson(e.detail.response.data.rules).path;
					for (var key in rules) {
						for (var i = 0; i < this.initialResponse.policies.length; i++) {
							if (key == 'sys/policy/' + this.initialResponse.policies[i]) delete rules[key];
						}
						if (key in rules) this.access[key] = rules[key];
					}
					this._watchPolicyRequests();
				},
				_policyFailure: function() {
					this._watchPolicyRequests();
				},
				_watchPolicyRequests: function() {
					if (this.initialResponse && this.initialResponse.policies && this.policyRequests.length == this.initialResponse.policies.length) {
						var bool = true;
						// Wait for all requests to return. Once complete, trigger _parseAccess()
						for (var i = 0; i < this.policyRequests.length; i++)
							if (this.policyRequests[i].status == 0) bool = false;
						if (bool) {
							this.policyRequests = [];
							this._parseAccess();
						}
					}
				},
    			_watchStatus: function() {
    				if (this.status != 'none' && this.status != '') {
						if (this.initialResponse.policies.length > 0) {
							for (var i = 0; i < this.initialResponse.policies.length; i++) {
								this.getPoliciesURL = app.url + 'v1/sys/policy/' + this.initialResponse.policies[i];
								this.push('policyRequests', this.$.getPolicy.generateRequest());
							}
						}
					}
    			}
			});
		})();
	</script>
</dom-module>
